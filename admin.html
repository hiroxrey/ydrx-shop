<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>YDRX | Admin</title>

<style>
:root{
  --bg:#050608;
  --neon:#29ff6a;
  --text:#e8fff1;
  --muted:#a8d6b8;
  --card: rgba(0,0,0,.55);
  --border: rgba(41,255,106,.55);
  --shadow: 0 0 12px rgba(41,255,106,.55), 0 0 28px rgba(41,255,106,.35);
}
*{box-sizing:border-box}
body{
  margin:0;
  padding:16px;
  background:var(--bg);
  color:var(--text);
  font-family: system-ui, sans-serif;
}
.box{
  max-width:1100px;
  margin:auto;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:14px;
  box-shadow:var(--shadow);
}
.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between
}
.grid{display:grid; gap:10px}
.card{
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  background:rgba(0,0,0,.45);
}
button,input,select,textarea{
  padding:10px 12px;
  border-radius:12px;
  border:1.5px solid var(--border);
  background:rgba(0,0,0,.45);
  color:var(--text);
}
button{cursor:pointer}
button:hover{background:rgba(41,255,106,.2)}
textarea{width:100%}
.muted{opacity:.75}
.small{font-size:12px}
.danger{
  border-color:#ff5a5a;
  color:#ffbcbc;
}
hr{
  border:0;
  border-top:1px solid rgba(41,255,106,.2);
  margin:14px 0;
}
</style>
</head>

<body>

<div class="box">
  <div class="row">
    <div>
      <b>Panel Admin</b>
      <div class="muted" id="who"></div>
    </div>
    <div class="row">
      <button onclick="location.href='dashboard.html'">Dashboard</button>
      <button onclick="YDRX.logout()">Salir</button>
    </div>
  </div>

  <hr>

  <!-- DAR SALDO -->
  <div class="card">
    <b>Dar saldo a usuario</b>
    <div class="row" style="margin-top:8px">
      <input id="saldoUser" placeholder="@user">
      <input id="saldoMonto" type="number" placeholder="Monto">
      <button onclick="darSaldo()">Agregar saldo</button>
    </div>
  </div>

  <hr>

  <!-- CREAR PRODUCTO -->
  <div class="card">
    <b>Crear producto</b>
    <div class="row" style="margin-top:8px">
      <input id="pName" placeholder="Nombre producto">
      <input id="pPerfil" type="number" placeholder="Precio perfil">
      <input id="pCompleta" type="number" placeholder="Precio completa">
      <button onclick="crearProducto()">Crear</button>
    </div>
  </div>

  <hr>

  <!-- PRODUCTOS -->
  <div id="products" class="grid"></div>
</div>

<script src="app.js"></script>
<script>
/* ===== SEGURIDAD ===== */
const me = YDRX.requireLogin();
if(me.role !== "admin"){
  alert("Acceso solo para admin");
  location.href="dashboard.html";
}
document.getElementById("who").textContent = me.user+" ("+me.email+")";

/* ===== SALDO ===== */
function darSaldo(){
  const user = document.getElementById("saldoUser").value.trim();
  const monto = Number(document.getElementById("saldoMonto").value);
  if(!user || !monto) return alert("Datos incompletos");

  const db = YDRX.loadDB();
  const u = db.users.find(x=>x.user===user);
  if(!u) return alert("Usuario no existe");

  u.balance += monto;
  YDRX.saveDB(db);
  alert("Saldo agregado correctamente");
}

/* ===== PRODUCTOS ===== */
function crearProducto(){
  YDRX.addProduct({
    name:pName.value,
    perfilPrice:pPerfil.value,
    completaPrice:pCompleta.value
  });
  pName.value=pPerfil.value=pCompleta.value="";
  render();
}

function toggleProducto(id){
  const db = YDRX.loadDB();
  const p = db.products.find(x=>x.id===id);
  p.active = !p.active;
  YDRX.saveDB(db);
  render();
}

function eliminarProducto(id){
  if(!confirm("¿Eliminar este producto y TODO su stock?")) return;
  const db = YDRX.loadDB();
  db.products = db.products.filter(p=>p.id!==id);
  YDRX.saveDB(db);
  render();
}

function addStock(id){
  const variant = document.getElementById("v_"+id).value;
  const items = document.getElementById("s_"+id).value.split("\n");
  YDRX.addStock(id, variant, items);
  render();
}

function delStock(pid,variant,index){
  const db = YDRX.loadDB();
  const p = db.products.find(p=>p.id===pid);
  p.variants[variant].stock.splice(index,1);
  YDRX.saveDB(db);
  render();
}

function render(){
  const db = YDRX.loadDB();
  const wrap = document.getElementById("products");
  wrap.innerHTML="";

  db.products.forEach(p=>{
    const div = document.createElement("div");
    div.className="card";

    let stockHTML = "";
    ["perfil","completa"].forEach(v=>{
      p.variants[v].stock.forEach((s,i)=>{
        stockHTML += `
          <div class="row small">
            <span>${v}: ${s}</span>
            <button class="danger" onclick="delStock('${p.id}','${v}',${i})">X</button>
          </div>`;
      });
    });

    if(!stockHTML) stockHTML = "<div class='muted small'>Sin stock</div>";

    div.innerHTML = `
      <div class="row">
        <b>${p.name}</b>
        <button class="danger small" onclick="eliminarProducto('${p.id}')">Eliminar</button>
      </div>

      <div class="small muted">
        Perfil $${p.variants.perfil.price} | Completa $${p.variants.completa.price}
      </div>

      <div class="row small">
        Estado: ${p.active ? "Activo" : "Inactivo"}
        <button onclick="toggleProducto('${p.id}')">ON / OFF</button>
      </div>

      <hr>

      <b>Agregar stock</b>
      <select id="v_${p.id}">
        <option value="perfil">perfil</option>
        <option value="completa">completa</option>
      </select>
      <textarea id="s_${p.id}" placeholder="Una cuenta por línea"></textarea>
      <button onclick="addStock('${p.id}')">Subir stock</button>

      <hr>

      <b>Stock actual</b>
      ${stockHTML}
    `;
    wrap.appendChild(div);
  });
}

render();
</script>
</body>
</html>
