<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Admin – Recargas</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body{font-family:Arial;background:#0b0b0b;color:#fff;padding:20px}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{border:1px solid #333;padding:8px;text-align:center}
    th{background:#111}
    button{padding:6px 10px;cursor:pointer}
    .ok{background:#16a34a;color:#fff;border:0}
    .no{background:#dc2626;color:#fff;border:0}
  </style>
</head>
<body>

<h2>Panel Admin – Recargas</h2>

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Usuario</th>
      <th>Monto</th>
      <th>Estado</th>
      <th>Acción</th>
    </tr>
  </thead>
  <tbody id="rows"></tbody>
</table>

<script>
/* ====== CONFIGURA ESTO ====== */
const SUPABASE_URL = "TU_SUPABASE_URL";
const SUPABASE_SERVICE_KEY = "TU_SERVICE_ROLE_KEY"; // SOLO ADMIN
/* ============================ */

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

async function cargar() {
  const { data } = await sb
    .from("recargas")
    .select("*")
    .order("created_at", { ascending: false });

  const tbody = document.getElementById("rows");
  tbody.innerHTML = "";

  data.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${r.usuario}</td>
      <td>${r.monto}</td>
      <td>${r.estado}</td>
      <td>
        ${r.estado === "pendiente"
          ? `<button class="ok" onclick="aprobar(${r.id},'${r.usuario}',${r.monto})">Aprobar</button>`
          : "—"}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function aprobar(id, usuario, monto) {
  // sumar saldo
  await sb.rpc("sumar_saldo_admin", {
    p_user: usuario,
    p_monto: monto
  });

  // marcar recarga entregada
  await sb
    .from("recargas")
    .update({ estado: "entregado" })
    .eq("id", id);

  cargar();
}

cargar();
</script>

</body>
</html>
