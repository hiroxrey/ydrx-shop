<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YDRX | Dashboard</title>
  <style>
    :root{
      --bg:#050608;
      --neon:#29ff6a;
      --neon2:#7CFFB1;
      --text:#e8fff1;
      --muted:#a8d6b8;
      --card: rgba(0,0,0,.55);
      --border: rgba(41,255,106,.55);
      --shadow: 0 0 12px rgba(41,255,106,.55), 0 0 28px rgba(41,255,106,.35), 0 0 60px rgba(41,255,106,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg);
      color: var(--text);
      padding: 16px;
    }
    .box{
      max-width: 980px;
      margin: 0 auto;
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      background: var(--card);
      box-shadow: var(--shadow);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between}
    button{
      cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      border:1.5px solid rgba(41,255,106,.85);
      background: rgba(41,255,106,.18);
      color: var(--text);
      box-shadow: 0 0 14px rgba(41,255,106,.20);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
      user-select:none;
    }
    button:hover{transform: translateY(-1px); box-shadow: 0 0 16px rgba(41,255,106,.30), 0 0 34px rgba(41,255,106,.16); background: rgba(41,255,106,.24);}
    button:active{transform: translateY(0) scale(.99);}
    button:disabled{opacity:.4; cursor:not-allowed; transform:none; box-shadow:none;}
    input{
      padding:10px 12px;
      border-radius:12px;
      border:1.5px solid rgba(41,255,106,.55);
      background: rgba(0,0,0,.45);
      color: var(--text);
      outline:none;
    }
    input:focus{border-color: rgba(41,255,106,.9); box-shadow: 0 0 0 3px rgba(41,255,106,.14);}
    .grid{display:grid; gap:10px}
    .card{
      border:1px solid rgba(41,255,106,.55);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.45);
      box-shadow: 0 0 18px rgba(41,255,106,.10);
    }
    .muted{opacity:.78}
    .tag{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(41,255,106,.55);
      font-size:12px;
      box-shadow: 0 0 12px rgba(41,255,106,.12);
    }
    pre{
      white-space:pre-wrap;
      background: rgba(0,0,0,.72);
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(41,255,106,.35);
      margin:10px 0 0;
      box-shadow: inset 0 0 0 1px rgba(41,255,106,.08);
    }
    hr{border:0; border-top:1px solid rgba(41,255,106,.18); margin:14px 0;}

    /* ---------- OVERLAY (CARGANDO / ENTREGA) ---------- */
    .overlay{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,.78);
      backdrop-filter: blur(10px);
      z-index: 9999;
    }
    .overlay.show{display:flex;}

    .modal{
      width:min(720px, 94vw);
      border-radius:20px;
      border:1.5px solid rgba(41,255,106,.65);
      background: rgba(0,0,0,.62);
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    .modal::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(900px 300px at 20% 0%, rgba(41,255,106,.20), transparent 55%),
        radial-gradient(800px 280px at 90% 110%, rgba(124,255,177,.14), transparent 55%);
      pointer-events:none;
    }

    .scanline{
      position:absolute;
      left:0; right:0;
      height: 120px;
      top:-140px;
      background: linear-gradient(180deg, transparent, rgba(41,255,106,.18), transparent);
      filter: blur(0.2px);
      animation: scan 1.6s linear infinite;
      opacity:.85;
      pointer-events:none;
    }
    @keyframes scan{
      0%{ transform: translateY(0); opacity:.0;}
      10%{opacity:.65;}
      50%{opacity:.85;}
      100%{ transform: translateY(980px); opacity:0;}
    }

    .loadingWrap, .deliveryWrap{
      position:relative;
      padding: 26px 22px 20px;
    }

    .brandBig{
      text-align:center;
      font-weight: 1000;
      letter-spacing: .28em;
      font-size: clamp(34px, 6vw, 64px);
      text-transform: uppercase;
      color: var(--text);
      text-shadow: 0 0 12px rgba(41,255,106,.6), 0 0 42px rgba(41,255,106,.25);
      user-select:none;
    }

    .glitch{
      position:relative;
      display:inline-block;
    }
    .glitch::before,
    .glitch::after{
      content: attr(data-text);
      position:absolute;
      left:0; top:0;
      width:100%;
      overflow:hidden;
      clip-path: inset(0 0 0 0);
      opacity:.55;
    }
    .glitch::before{
      transform: translate(2px, -1px);
      color: rgba(41,255,106,.9);
      animation: glitch1 1.2s infinite linear alternate-reverse;
    }
    .glitch::after{
      transform: translate(-2px, 1px);
      color: rgba(124,255,177,.9);
      animation: glitch2 1.4s infinite linear alternate-reverse;
    }
    @keyframes glitch1{
      0%{clip-path: inset(0 0 85% 0)}
      20%{clip-path: inset(10% 0 55% 0)}
      40%{clip-path: inset(40% 0 25% 0)}
      60%{clip-path: inset(70% 0 10% 0)}
      80%{clip-path: inset(15% 0 60% 0)}
      100%{clip-path: inset(55% 0 20% 0)}
    }
    @keyframes glitch2{
      0%{clip-path: inset(75% 0 0 0)}
      25%{clip-path: inset(45% 0 20% 0)}
      50%{clip-path: inset(20% 0 55% 0)}
      75%{clip-path: inset(5% 0 70% 0)}
      100%{clip-path: inset(60% 0 15% 0)}
    }

    .loadingText{
      text-align:center;
      margin-top: 10px;
      font-size: 14px;
      color: rgba(232,255,241,.86);
      letter-spacing: .08em;
    }
    .dots::after{
      content:"";
      display:inline-block;
      width: 2.4em;
      text-align:left;
      animation:dots 1.1s infinite steps(4,end);
    }
    @keyframes dots{
      0%{content:"";}
      25%{content:".";}
      50%{content:"..";}
      75%{content:"...";}
      100%{content:"";}
    }

    .pulseRing{
      width: 110px;
      height: 110px;
      border-radius: 999px;
      margin: 18px auto 0;
      border: 2px solid rgba(41,255,106,.55);
      box-shadow: 0 0 18px rgba(41,255,106,.20);
      position:relative;
    }
    .pulseRing::before{
      content:"";
      position:absolute; inset: 8px;
      border-radius: 999px;
      border: 2px solid rgba(124,255,177,.35);
      animation: pulse 1.25s ease-in-out infinite;
    }
    .pulseRing::after{
      content:"";
      position:absolute; inset: 0;
      border-radius: 999px;
      background: radial-gradient(circle at 50% 50%, rgba(41,255,106,.14), transparent 60%);
      filter: blur(.2px);
    }
    @keyframes pulse{
      0%{transform:scale(.92); opacity:.55}
      50%{transform:scale(1.06); opacity:1}
      100%{transform:scale(.92); opacity:.55}
    }

    .deliveryTitle{
      font-weight: 900;
      font-size: 18px;
      margin: 0 0 6px;
    }
    .deliverySub{
      margin:0 0 10px;
      color: rgba(168,214,184,.95);
      font-size: 13px;
      line-height:1.35;
    }
    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top: 14px;
    }
    .btnGhost{
      background: rgba(0,0,0,.35);
      border-color: rgba(41,255,106,.55);
    }
    .mini{
      font-size: 12px;
      opacity:.85;
      margin-top:10px;
    }
    .warn{
      border:1px solid rgba(255,195,95,.35);
      background: rgba(255,195,95,.08);
      border-radius:14px;
      padding:10px 12px;
      margin-top: 10px;
      color: rgba(255,235,205,.95);
      font-size: 12.5px;
      line-height:1.35;
    }
  </style>
</head>
<body>

  <div class="box">
    <div class="row">
      <div>
        <b id="who"></b>
        <span class="tag" id="roleTag"></span>
        <div class="muted">Saldo: <b id="balance">$0.00</b></div>
      </div>
      <div class="row">
        <button id="adminBtn" style="display:none;">Panel Admin</button>
        <button id="logoutBtn">Salir</button>
      </div>
    </div>

    <hr>

    <div class="grid">
      <div class="card">
        <b>Recargar saldo (prueba)</b>
        <div class="muted">Crea una recarga pendiente para que el admin la apruebe.</div>
        <div class="row" style="margin-top:10px">
          <input id="topupAmount" type="number" min="1" placeholder="Monto" />
          <input id="topupRef" type="text" placeholder="Referencia (opcional)" />
          <button id="topupBtn">Enviar recarga</button>
        </div>
      </div>

      <div class="card">
        <b>Productos</b>
        <div id="products" class="grid" style="margin-top:10px"></div>
      </div>

      <div class="card">
        <b>Mis compras</b>
        <div id="orders" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <!-- OVERLAY -->
  <div class="overlay" id="overlay">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="scanline"></div>

      <!-- LOADING -->
      <div class="loadingWrap" id="loadingWrap">
        <div class="brandBig">
          <span class="glitch" data-text="YDRX">YDRX</span>
        </div>
        <div class="pulseRing"></div>
        <div class="loadingText">
          CARGANDO<span class="dots"></span>
        </div>
        <div class="mini muted" style="text-align:center">
          Procesando compra y preparando entrega…
        </div>
      </div>

      <!-- DELIVERY -->
      <div class="deliveryWrap" id="deliveryWrap" style="display:none;">
        <div class="brandBig" style="font-size: clamp(28px, 4vw, 44px); letter-spacing:.22em;">
          ENTREGA
        </div>

        <p class="deliveryTitle">Listo ✅ Aquí está tu cuenta</p>
        <p class="deliverySub">
          1) Copia los datos <br>
          2) Inicia sesión en el servicio <br>
          3) No compartas esta info con nadie
        </p>

        <div class="warn">
          ⚠️ Recomendación: cambia la contraseña / PIN si aplica. Si el servicio pide verificación, sigue las instrucciones del proveedor.
        </div>

        <pre id="deliveredBox"></pre>

        <div class="btnRow">
          <button class="btnGhost" id="copyBtn">Copiar</button>
          <button id="okBtn">Entendido</button>
        </div>

        <div class="mini muted">
          Si cierras esta ventana, tu entrega queda guardada en <b>Mis compras</b>.
        </div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    // Proteger página
    const me = YDRX.requireLogin();

    const who = document.getElementById("who");
    const roleTag = document.getElementById("roleTag");
    const balanceEl = document.getElementById("balance");
    const adminBtn = document.getElementById("adminBtn");

    const overlay = document.getElementById("overlay");
    const loadingWrap = document.getElementById("loadingWrap");
    const deliveryWrap = document.getElementById("deliveryWrap");
    const deliveredBox = document.getElementById("deliveredBox");
    const copyBtn = document.getElementById("copyBtn");
    const okBtn = document.getElementById("okBtn");

    function money(n){ return "$" + Number(n||0).toFixed(2); }

    function refreshHeader(){
      const u = YDRX.currentUser();
      who.textContent = u.user + " (" + u.email + ")";
      roleTag.textContent = u.role;
      balanceEl.textContent = money(u.balance);
      adminBtn.style.display = (u.role === "admin") ? "inline-block" : "none";
    }

    function showOverlayLoading(){
      deliveredBox.textContent = "";
      deliveryWrap.style.display = "none";
      loadingWrap.style.display = "block";
      overlay.classList.add("show");
    }

    function showOverlayDelivery(text){
      loadingWrap.style.display = "none";
      deliveryWrap.style.display = "block";
      deliveredBox.textContent = text || "";
    }

    function hideOverlay(){
      overlay.classList.remove("show");
      deliveryWrap.style.display = "none";
      loadingWrap.style.display = "block";
    }

    // Cerrar con ESC
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && overlay.classList.contains("show")) hideOverlay();
    });

    okBtn.addEventListener("click", () => {
      hideOverlay();
      refreshAll();
    });

    copyBtn.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(deliveredBox.textContent);
        copyBtn.textContent = "Copiado ✅";
        setTimeout(()=> copyBtn.textContent = "Copiar", 1200);
      }catch{
        alert("No se pudo copiar. Copia manual.");
      }
    });

    async function buyFlow(pId, variant){
      showOverlayLoading();

      // mini delay para que se vea la animación (se siente pro)
      await new Promise(r => setTimeout(r, 900));

      try{
        const order = YDRX.buyProduct({ pId, variant });
        const delivered = order.items[0].delivered;
        showOverlayDelivery(delivered);
      }catch(err){
        hideOverlay();
        alert(err.message);
      }
    }

    function renderProducts(){
      const wrap = document.getElementById("products");
      wrap.innerHTML = "";
      const products = YDRX.listProducts();

      products.forEach(p => {
        const perfilPrice = p.variants.perfil.price;
        const completaPrice = p.variants.completa.price;
        const perfilStock = p.variants.perfil.stock.length;
        const completaStock = p.variants.completa.stock.length;

        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="row">
            <div>
              <b>${p.name}</b>
              <div class="muted">Elige: Perfil o Completa</div>
            </div>
            <span class="tag">En stock</span>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <b>Perfil</b> ${money(perfilPrice)}
              <span class="muted">Stock: ${perfilStock}</span>
            </div>
            <button ${perfilStock<=0 ? "disabled" : ""} data-buy="${p.id}|perfil">Comprar Perfil</button>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <b>Completa</b> ${money(completaPrice)}
              <span class="muted">Stock: ${completaStock}</span>
            </div>
            <button ${completaStock<=0 ? "disabled" : ""} data-buy="${p.id}|completa">Comprar Completa</button>
          </div>
        `;
        wrap.appendChild(div);
      });

      wrap.querySelectorAll("button[data-buy]").forEach(btn => {
        btn.addEventListener("click", () => {
          const [pId, variant] = btn.getAttribute("data-buy").split("|");
          buyFlow(pId, variant);
        });
      });
    }

    function renderOrders(){
      const el = document.getElementById("orders");
      const orders = YDRX.myOrders();
      if (!orders.length){
        el.innerHTML = `<div class="muted">Aún no tienes compras.</div>`;
        return;
      }
      el.innerHTML = orders.map(o => {
        const it = o.items[0];
        return `
          <div class="card">
            <div><b>${it.name}</b> (${it.variant}) - ${money(it.price)}</div>
            <div class="muted">${new Date(o.when).toLocaleString()}</div>
            <div style="margin-top:8px" class="muted">Entrega:</div>
            <pre>${it.delivered}</pre>
          </div>
        `;
      }).join("");
    }

    function refreshAll(){
      refreshHeader();
      renderProducts();
      renderOrders();
    }

    document.getElementById("logoutBtn").onclick = () => YDRX.logout();
    document.getElementById("adminBtn").onclick = () => window.location.href = "admin.html";

    document.getElementById("topupBtn").onclick = () => {
      try{
        YDRX.requestTopup({
          amount: document.getElementById("topupAmount").value,
          ref: document.getElementById("topupRef").value
        });
        alert("Recarga enviada (pendiente).");
        document.getElementById("topupAmount").value = "";
        document.getElementById("topupRef").value = "";
      }catch(err){
        alert(err.message);
      }
    };

    refreshAll();
  </script>
</body>
</html>
